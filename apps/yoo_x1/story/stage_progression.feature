Feature: Stage Progression
  管理六个主关卡及 Extra/Phantasm 的启动、结束与难度流程。

  Background:
    Given 系统已定义「关卡配置表」:
      | 关卡类型 | 关卡号 | 关卡名称           | 背景音乐ID     | BOSS名称               |
      | 主关卡   | 1      | 雪与樱的故乡       | BGM_S1         | 琪露诺                 |
      | 主关卡   | 2      | 无人的厅堂         | BGM_S2         | 蕾迪·霍瓦特洛克       |
      | 主关卡   | 3      | 白玉楼的阶梯       | BGM_S3         | 爱丽丝·玛格特洛依德   |
      | 主关卡   | 4      | 樱花的幻想         | BGM_S4         | 普莉兹姆利巴三姐妹   |
      | 主关卡   | 5      | 墨染的樱花         | BGM_S5         | 魂魄妖梦               |
      | 主关卡   | 6      | 冥界之旅           | BGM_S6         | 西行寺幽幽子           |
      | Extra    | EX     | 紫色的海           | BGM_EX         | 八云蓝                 |
      | Phantasm | PH     | 境界之間           | BGM_PH         | 八云紫                 |
    And 系统已定义「地图背景配置表」:
      | 关卡号 | 主背景           | 前景元素         | 滚动速度 | 环境效果     | 特殊装饰             |
      | 1      | 雪景樱花林       | 飘落雪花         | 2px/帧   | 雪花飘散     | 粉色樱花瓣           |
      | 2      | 白玉楼外廊       | 石柱回廊         | 3px/帧   | 寒气缭绕     | 冰晶装饰             |
      | 3      | 石阶小径         | 白玉石阶         | 2.5px/帧 | 雾气弥漫     | 古典灯笼             |
      | 4      | 樱花幻境         | 樱花树丛         | 4px/帧   | 花瓣旋舞     | 幻象光影             |
      | 5      | 半开樱园         | 墨色樱树         | 3px/帧   | 阴阳交替     | 半透明樱花           |
      | 6      | 冥界庭园         | 彼岸花田         | 2px/帧   | 灵魂飘浮     | 死蝶群舞             |
      | EX     | 蓝色异空间       | 几何图案         | 5px/帧   | 空间扭曲     | 式神符文             |
      | PH     | 境界缝隙         | 裂隙边界         | 6px/帧   | 现实撕裂     | 紫色光带             |
    And 系统已定义「地图边界配置表」:
      | 关卡号 | 游戏区域宽度 | 游戏区域高度 | 玩家移动边界左 | 玩家移动边界右 | 玩家移动边界上 | 玩家移动边界下 |
      | ALL    | 640px        | 480px        | 32px           | 608px          | 16px           | 464px          |
    And 系统已定义「普通敌机配置表」:
      | 关卡号 | 敌机类型     | 出现时机   | HP  | 移动模式   | 弹幕类型     |
      | 1      | 雪妖精       | 开场       | 15  | 直线       | 单发弹       |
      | 1      | 冰妖精       | 中期       | 25  | 波浪       | 散射弹       |
      | 2      | 寒气妖精     | 开场       | 20  | 螺旋       | 冰晶弹       |
      | 2      | 雪女仆       | 中期       | 35  | 追踪       | 扇形弹       |
      | 3      | 人偶兵       | 开场       | 30  | 编队       | 直线弹       |
      | 3      | 魔法人偶     | 中期       | 45  | 瞬移       | 魔力弹       |
      | 4      | 春妖精       | 开场       | 25  | 飞舞       | 花瓣弹       |
      | 4      | 骚灵        | 中期       | 40  | 漂浮       | 音符弹       |
      | 5      | 幽灵        | 开场       | 35  | 穿墙       | 灵力弹       |
      | 5      | 半灵        | 中期       | 50  | 分身       | 剑气弹       |
      | 6      | 死灵        | 开场       | 45  | 群聚       | 蝶弹         |
      | 6      | 亡灵蝶      | 后期       | 60  | 环绕       | 死亡弹       |
    And 系统已定义「BOSS配置表」:
      | BOSS名称             | 关卡号 | 通常攻击阶段数 | 符卡数量 | 总HP    |
      | 琪露诺               | 1      | 2              | 2        | 1500    |
      | 蕾迪·霍瓦特洛克     | 2      | 3              | 3        | 2200    |
      | 爱丽丝·玛格特洛依德 | 3      | 3              | 4        | 2800    |
      | 普莉兹姆利巴三姐妹 | 4      | 4              | 5        | 3500    |
      | 魂魄妖梦             | 5      | 4              | 6        | 4200    |
      | 西行寺幽幽子         | 6      | 5              | 7        | 5000    |
      | 八云蓝               | EX     | 6              | 8        | 6000    |
      | 八云紫               | PH     | 7              | 9        | 8000    |
    And 系统已定义「地图特殊区域配置表」:
      | 关卡号 | 特殊区域类型   | 位置坐标       | 触发效果         | 持续时间 |
      | 1      | 樱花飞舞区域   | (200,100,100,80) | 樱点自动收集     | 5秒      |
      | 3      | 雾气迷障       | (150,200,200,60) | 视野模糊         | 8秒      |
      | 4      | 幻象回廊       | (100,150,150,100)| 敌机幻影分身     | 6秒      |
      | 6      | 死境漩涡       | (300,250,80,80)  | 弹幕速度减半     | 4秒      |

  Rule: 关卡加载 — 根据难度和编号初始化资源

    Scenario Outline: 关卡启动
      Given 玩家在难度 <难度> 下开始游戏
      When 关卡编号为 <关卡号> 加载完成
      Then 播放对应的关卡背景音乐
      And 显示关卡标题与BOSS剪影
      And 加载该关卡的普通敌机配置
      And 初始化地图背景与环境效果

      Examples:
        | 难度    | 关卡号 |
        | Easy    | 1      |
        | Normal  | 3      |
        | Hard    | 6      |
        | Lunatic | EX     |

  Rule: 地图滚动机制 — 背景按配置速度向下滚动

    Scenario Outline: 地图背景滚动
      Given 关卡 <关卡号> 已开始
      When 游戏帧更新
      Then 主背景以 <滚动速度> 向下滚动
      And 前景元素同步滚动
      And 环境效果 <环境效果> 持续播放

      Examples:
        | 关卡号 | 滚动速度 | 环境效果 |
        | 1      | 2px/帧   | 雪花飘散 |
        | 4      | 4px/帧   | 花瓣旋舞 |
        | EX     | 5px/帧   | 空间扭曲 |

  Rule: 玩家移动边界 — 限制玩家在有效游戏区域内移动

    Scenario: 玩家边界检测
      Given 玩家当前位置为 (x, y)
      When 玩家尝试移动到新位置
      Then 检查新位置是否在移动边界内
      And 如果超出边界则限制在边界位置
      And 保持玩家在 (32px, 608px, 16px, 464px) 矩形内

    Scenario Outline: 边界碰撞处理
      Given 玩家位于 <当前位置>
      When 玩家向 <移动方向> 移动
      Then 玩家最终位置为 <最终位置>

      Examples:
        | 当前位置  | 移动方向 | 最终位置  |
        | (30, 100) | 左       | (32, 100) |
        | (610, 200)| 右       | (608, 200)|
        | (100, 10) | 上       | (100, 16) |
        | (100, 470)| 下       | (100, 464)|

  Rule: 地图环境效果 — 不同关卡的视觉与音效环境

    Scenario Outline: 环境效果激活
      Given 进入关卡 <关卡号>
      When 地图加载完成
      Then 激活 <环境效果>
      And 在前景显示 <特殊装饰>
      And 粒子效果按地图主题播放

      Examples:
        | 关卡号 | 环境效果 | 特殊装饰     |
        | 1      | 雪花飘散 | 粉色樱花瓣   |
        | 2      | 寒气缭绕 | 冰晶装饰     |
        | 6      | 灵魂飘浮 | 死蝶群舞     |
        | PH     | 现实撕裂 | 紫色光带     |

  Rule: 特殊区域交互 — 地图中的特殊区域提供临时效果

    Scenario Outline: 特殊区域触发
      Given 关卡 <关卡号> 存在特殊区域 <区域类型>
      When 玩家进入区域坐标范围
      Then 触发 <触发效果>
      And 效果持续 <持续时间>
      And 播放对应的视觉提示

      Examples:
        | 关卡号 | 区域类型     | 触发效果       | 持续时间 |
        | 1      | 樱花飞舞区域 | 樱点自动收集   | 5秒      |
        | 3      | 雾气迷障     | 视野模糊       | 8秒      |
        | 4      | 幻象回廊     | 敌机幻影分身   | 6秒      |
        | 6      | 死境漩涡     | 弹幕速度减半   | 4秒      |

  Rule: 地图装饰物交互 — 非碰撞装饰元素的视觉层次

    Scenario: 装饰物层次渲染
      Given 地图包含装饰元素
      When 渲染游戏画面
      Then 背景层在最底层
      And 装饰物在背景层之上
      And 游戏实体在装饰物之上
      And UI元素在最顶层

    Scenario: 装饰物动画效果
      Given 地图装饰物支持动画
      When 游戏运行中
      Then 樱花瓣按风向飘落
      And 灯笼发出温暖光晕
      And 死蝶群作螺旋飞舞
      And 所有动画不影响游戏逻辑判定

  Rule: 普通敌机生成规则 — 按时机和配置生成敌机

    Scenario Outline: 普通敌机出现
      Given 关卡 <关卡号> 已开始
      When 到达 <出现时机> 阶段
      Then 生成 <敌机类型> 敌机
      And 敌机HP设置为 <HP>
      And 敌机采用 <移动模式> 移动方式
      And 敌机发射 <弹幕类型>

      Examples:
        | 关卡号 | 出现时机 | 敌机类型 | HP | 移动模式 | 弹幕类型 |
        | 1      | 开场     | 雪妖精   | 15 | 直线     | 单发弹   |
        | 3      | 中期     | 魔法人偶 | 45 | 瞬移     | 魔力弹   |
        | 5      | 后期     | 半灵     | 50 | 分身     | 剑气弹   |

  Rule: BOSS战触发规则 — 普通敌机清理完毕后进入BOSS战

    Scenario Outline: BOSS战开始
      Given 关卡 <关卡号> 的普通敌机已全部击败
      When BOSS <BOSS名称> 登场
      Then 播放BOSS登场动画
      And 显示BOSS名称与立绘
      And 初始化BOSS HP为 <总HP>
      And 开始第一个通常攻击阶段
      And 地图滚动暂停

      Examples:
        | 关卡号 | BOSS名称             | 总HP |
        | 1      | 琪露诺               | 1500 |
        | 3      | 爱丽丝·玛格特洛依德 | 2800 |
        | 6      | 西行寺幽幽子         | 5000 |
        | EX     | 八云蓝               | 6000 |

  Rule: BOSS阶段进程 — 通常攻击与符卡交替进行

    Scenario: BOSS攻击阶段转换
      Given BOSS当前处于通常攻击阶段
      When BOSS当前阶段HP耗尽
      Then 进入对应的符卡宣言阶段
      And 暂停BOSS移动
      And 清除屏幕上的弹幕
      And 地图背景切换为符卡专用背景

    Scenario: 符卡阶段结束转换
      Given BOSS当前处于符卡阶段
      When 符卡被击破或时间耗尽
      Then 进入下一个通常攻击阶段
      And 恢复BOSS正常移动模式
      And 重置弹幕发射模式
      And 恢复正常地图背景

  Rule: 关卡结算 — BOSS击破后展示评分

    Scenario: 关卡完结与评分结算
      When BOSS总HP归零且所有阶段完成
      Then 播放通关音效
      And 显示评分结算面板
      And 统计击破敌机数、擦弹数、收集樱点数
      And 解锁下一关卡（如有）
      And 停止地图滚动和环境效果

  Rule: 特殊关卡解锁 — Extra和Phantasm的解锁条件

    Scenario: Extra关卡解锁
      Given 玩家在Normal难度以上通关Stage6
      And 未使用Continue
      When 返回标题画面
      Then Extra关卡选项变为可选

    Scenario: Phantasm关卡解锁
      Given 玩家已通关Extra关卡
      And 在Extra关卡中收集所有特殊道具
      When 返回标题画面
      Then Phantasm关卡选项变为可选 